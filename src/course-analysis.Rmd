## Analysis of My Course Data

```{r setup, echo=F, message=F, warning=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)


#### LIBRARIES ####
library(dplyr)
library(purrr)
library(readr)
library(tidyr)
library(stringr)
library(pdftools)
library(reshape2)
library(ggplot2)
library(tibble)
library(xtable)

#### CONSTANTS ####

enrollment_data_path <- "../data/enrollment"
evaluations_data_path <- "../data/evaluations"
instructor_first_name <- "Jeffrey"
instructor_last_name <- "Naecker"
master_string <- "(\\W{6,8}[0-9]{1,2}\\..*)|(\\W{16,16}.*\n\\W{20,})"
theme_set(theme_minimal())

#### FUNCTIONS ####

extract_response_data <- function(response_text){
  response <- response_text %>% 
    str_replace_all("\nCopyright Wesleyan University\\W*[0-9]{1,2}/[0-9]{1,2}\n", "") %>% # remove headers
    str_replace_all(paste(instructor_last_name, ", ", instructor_first_name, " \\(\\s?[A-Z]{3,4} [0-9]{3}\\)", sep = ""), "") # remove footers
  
  questions <- response %>%
    str_extract_all(master_string) %>%
    unlist() %>%
    str_replace_all("[0-9]{1,2}\\. ", "") %>% # remove qestion numbers
    str_replace_all("^(\"|\\.|!|\\])", "") %>% # remove misc punctuation at beginning of line
    str_replace_all("\\[$", "") %>%           # remove misc punctuation at end of line
    str_replace_all("\\.\\\n", "") %>%           # random fix
    str_trim()
  
  answers <- response %>%
    str_split(master_string) %>%
    unlist() %>%
    str_replace_all("Copyright Wesleyan University\\W*[0-9]{1,2}/[0-9]{1,2}", "") %>% # clean up page break
    str_replace_all("\n", "") %>% #remove line breaks
    str_replace_all("comment on anything else not yet addressed\\.", "") %>% #random fix
    str_trim() %>%
    gsub("([0-9])-\\w.*$", "\\1", .) # remove text from numerical responses
  
  data.frame(
    questions = questions,
    answers = unlist(answers)[-1]
  ) %>%
    subset(answers != "")
}

extract_evaluation_data <- function(document_name) {
  text <- pdf_text(file.path(evaluations_data_path, document_name))[1]
  data_frame(
    semester = str_extract(text, "Fall|Spring"),
    year = str_extract(text, "20[0-9]{2,2}"),
    department = str_extract(text, "[A-Z]{3,4}"),
    course = str_match(text, "([A-Z]{3,4}) ([0-9]{3,3})")[,3],
    audience = str_match(text, "(Project Audience) ([0-9]+)")[,3],
    responses_received = str_match(text, "(Responses Received) ([0-9]+)")[,3]
  )
}

extract_responses <- function(document_name) {
  responses <- pdf_text(file.path(evaluations_data_path, document_name)) %>%
    paste(., collapse = "") %>% 
    str_split("Course Evaluation Form( \\(continued\\))\n", ) %>%
    unlist()
  data.frame(
    response_number = c(1:length(responses)),
    responses = responses
  )
}

#### DATA IMPORT ####

##### import enrollment data #####
enrollments <- 
  data_frame(
    course = list.files(path = enrollment_data_path, pattern = "*.csv")
  ) %>%
  mutate(contents = map(
    course, 
    ~ read_csv(file.path(enrollment_data_path, .), col_types = cols(
      `Class Year` = col_character(), 
      WesPO = col_character()),
      )
    )) %>%
  unnest() %>%
  mutate(
    department = str_extract(course, "[A-Z]{3,4}"),
    semester_code = str_extract(course, "[0-9]{4}"),
    course = str_extract(course, "[0-9]{3}"),
    year = 2000 + (as.numeric(semester_code) %% 1000) %/% 10,
    semester = ifelse(as.numeric(semester_code)  %% 10 == 9, "Fall", "Spring"),
    semester_year = as.numeric(year) + ifelse(semester == "Fall", 0.5, 0),
    GPA = case_when(
      .$Grade == "A+" ~ 4.3,
      .$Grade == "A"  ~ 4.0,
      .$Grade == "A-" ~ 3.7,
      .$Grade == "B+" ~ 3.5,
      .$Grade == "B"  ~ 3.0,
      .$Grade == "B-" ~ 2.7,
      .$Grade == "C+" ~ 2.3,
      .$Grade == "C"  ~ 2.0,
      .$Grade == "C-" ~ 1.7,
      TRUE            ~ NaN)
  ) %>%
  select(semester, year, semester_code, semester_year, department, course, Name, WesID, `E-mail`, Credit, `Class Year`, Grade, GPA, Majors, `Prereq Met`)

## make enrollment variables have right class
varnames <- names(enrollments)
for (i in c(1:length(varnames))){
  if (str_detect(varnames[i], "Name|E-mail|WesID")){
    enrollments[[i]] <- as.character(enrollments[[i]])
  } else 
  if (str_detect(varnames[i], "Grade")) {
    enrollments[[i]] <- factor(enrollments[[i]], levels = c("A+", "A", "A-", "B+", "B", "B-", "C+", "C", "C-", "CR", "W"))
  } else   
  if (str_detect(varnames[i], "^semester$")) {
    enrollments[[i]] <- factor(enrollments[[i]], levels = c("Spring", "Fall"))
  } else 
  if (str_detect(varnames[i], "^(GPA|year)$")) {
    enrollments[[i]] <- as.numeric(enrollments[[i]])
  } else {
    enrollments[[i]] <- as.factor(enrollments[[i]])
  } 
}

## agregate to course semester level
course_semester_enrollments <-
  enrollments %>% 
  group_by(semester, year, semester_year, department, course) %>%
  summarize(
    enroll_count = n(),
    GPA = mean(GPA, na.rm=T)
  ) %>%
  arrange(year)

##### import evaluation data #####
evaluations <- 
  data_frame(
    document_name = list.files(path = evaluations_data_path, pattern = ".*Response Sheet.*.pdf")
  ) %>%
  mutate(
    evaluation_data = map(document_name, ~ extract_evaluation_data(.))
  ) %>% 
  unnest() %>% 
  mutate(
    responses = map(document_name, ~ extract_responses(.))  
  ) %>% 
  unnest() %>%
  mutate(
    response_data = map(responses, ~ extract_response_data(.))
  ) %>%
  unnest() %>% 
  dcast(semester + year + department + course + response_number ~ questions, value.var = "answers") %>%
  mutate(semester_year = as.numeric(year) + ifelse(semester == "Fall", 0.5, 0)) %>%
  as_tibble()

## make evaluation variables have right class
varnames <- names(evaluations)
for (i in c(1:length(varnames))){
  if(str_detect(varnames[i], "(C|c)omment|advice")){
    evaluations[[i]] <- as.character(evaluations[[i]])
  } else 
  if (str_detect(varnames[i], "expected grade")) {
    evaluations[[i]] <- factor(evaluations[[i]], levels = c("A+ or A", "A- or B+", "B or B-", "C+ or C"))
  } else
  if (str_detect(varnames[i], "percentage of class sessions")) {
    evaluations[[i]] <- factor(evaluations[[i]], levels = c("91 - 100", "81 - 90", "71 - 80", "61 - 70", "51 - 60", "41 - 50", "31 - 40", "21 - 30"))
  } else
  if (str_detect(varnames[i], "^semester$")) {
    evaluations[[i]] <- factor(evaluations[[i]], levels = c("Spring", "Fall"))
  } else
  if (str_detect(varnames[i], "^(department|course)$")) {
    evaluations[[i]] <- as.factor(evaluations[[i]])
  } else {
    evaluations[[i]] <- as.numeric(evaluations[[i]])
  }
}

##### aggregate to course-semester level
course_semester_evaluations <-
  evaluations %>% 
  group_by(semester, year, semester_year, department, course) %>%
  summarize(
    eval_count = n(),
    course_rating = mean(`The Course`, na.rm=T),
    teaching_rating = mean(`The Teaching`, na.rm=T)
  ) %>%
  arrange(year)

course_semesters <-
  course_semester_evaluations %>%
  merge(course_semester_enrollments, by = c("semester", "year", "semester_year", "department", "course"), all = T) %>%
  as_tibble() %>%
  arrange(year)
```

Let's start by looking at my performance over time in the two key metrics:

```{r key-metrics}
ggplot(evaluations, aes(x = as.factor(semester_year), y = `The Teaching`)) + 
  geom_jitter(width = 0, alpha = 0.2) +
  stat_summary(color = "red")

ggplot(evaluations, aes(x = as.factor(semester_year), y = `The Course`)) + 
  geom_jitter(width = 0, alpha = 0.2) +
  stat_summary(color = "red")
```

These two variables are highly correlated:

```{r}
ggplot(aes(x=`The Course`, y=`The Teaching`), data = evaluations) + 
  geom_jitter(width=.1, height=.1) + 
  stat_smooth(method = "lm")
```

Interestingly, there is not much correlation between the course rating and the reported effort.

```{r}
ggplot(aes(x=`The Course`, y=`On average, how many hours per week did you spend on coursework outside of class?`), data = evaluations) + 
  geom_jitter(width=.1, height=.1) + 
  stat_smooth(method = "loess")
```

It appears that students with lower expected grades work harder in my courses:

```{r}
ggplot(aes(x=`What is your expected grade in this course?`, y=`On average, how many hours per week did you spend on coursework outside of class?`),
       data = subset(evaluations, !is.na(`On average, how many hours per week did you spend on coursework outside of class?`))) +
  stat_boxplot()
```

Let's see what the distribution of grades I give is:

```{r}
xtabs(~ course + Grade, data = subset(enrollments, course %in% c("301", "211", "311")), drop.unused.levels = T)

enrollments %>% 
  filter(course %in% c("301", "211", "311")) %>%
  ggplot(aes(x=Grade)) + geom_bar() + facet_wrap(~course, nrow = 3)

```

Is there any pattern to the average grades in my classes?

```{r}
ggplot(subset(enrollments, course %in% c("301", "211", "311")), aes(x=semester_year, y=GPA)) + 
  stat_summary() +
  facet_wrap(~course)
```


What is my number of unique students taught?

```{r}
length(unique(enrollments$WesID))

```


```{r}
# potential TAs
# enrollments %>%
#   filter(`Class Year` %in% c(2018, 2019, 2020) & Grade %in% c("A+", "A", "A-", "B+")) %>%
#   select(`E-mail`)
```


## Course Diaries

### Econ 301

#### Spring 2017

```{r results='asis'}
responses <- c(
  "None.",
  "Good advice! Will pass on to next semester's students.",
  "Will try to make in-class problems closer to problem sets.",
  "Will look for more direct applications, but I think level of theory and use of muti-variate calculus in my class is appropriate when compared to other instructors. Will try to make in-class problems closer to problem sets.",
  "Will try to add more numerical examples, though one of the main learning goals for this course is working with variables and abstract quantities.",
  "None.",
  "None.",
  "Agree that exams were a little too long/hard, especially second midterm. I was clear, however, that I do not expect median student to finish exam.",
  "Disagree with the characterization that slides were 'full of typos'. Probably found a small typo in slides about once per week, which I corrected in class and posted corrected slides online.",
  "Agree that I took far to long to return firs midterm (though 6 week number includes spring break, when I was traveling). Exams and problem sets do include some qualitative questions, but I will try to increase this. Re: exam difficulty, see above.",
  "Exams are intended to have some problems that involve novel combinations of concepts in the class; this is how true understanding is revealed!  Will work to improve connection between lecture time and problem sets. Interesting comment about leaving more derivations to the textbook; I feel that if not covered in lecture, most students would not put in work to understand where these formulas come from.  You **should** be teadching yourself to some extent! Re: giving topics on problem set problems, figuring out what tools to use is part of the learning process!",
  "Good advice! Will pass on to next semester's students.",
  "None.",
  "Good advice! Will pass on to next semester's students.",
  "None.",
  "I appreciate the suggestion about going over exam and problem set problems after the fact in class.However, I don't think I can justify taking time away from learning new material to do this. Note that I do provide detailed solutions for all problem sets and exams, and am happy to go over these in detail with students in office hours.",
  "Will consider making exams and problem sets slightly shorter and easier.",
  "Will try to add more numerical examples.",
  "Problem sets are *intended* to be harder than examples in lecture.",
  "None.",
  "Will make assessments slightly easier/clearer/shorter in future.",
  "The point of not puting everything on the slides is to force the students to generate their own examples/solutions before seeing mine.",
  "Appreciate the point about using slides, but I think benefits for most students outweight costs. Re: exam difficulty, I don't follow that a difficult exam is necessarily unfair. All exams include easier components that most students should get, as well as more difficult ones that only top students might get. Will make exams slightly shorter in future, but don't have much slack until top students start getting perfect scores.  Re: office hours, this was listed below TA and Piazza Q&A on my list of places to get help, but this was done to encourage using these group resources, not to discourage coming to my office hours.",
  "Will post problem sets much earlier next semester.",
  "This courses is intended to be fairly theoretical (it is called Microeconomic Theory, after all). Elective courses are intended to be more applied.",
  "See previous comments on difficulty and mathematical rigor.",
  "See previous comments on numerical vs abstract quantities.",
  "None.",
  "None."
)

evaluations %>% 
  filter(semester == "Spring" & year == 2017 & course == "301") %>%
  mutate(`Instructor Response` = responses) %>%
  select(`The Course`, `The Teaching`, matches("Please comment"), matches("Do you have any"), `Instructor Response`) %>%
  xtable() %>%
  print(type = "html")
```

Summary thoughts:

- It seems that many students did not understand that problem sets and exams might force them to step a little bit outside their comfort zone, for example by connecting two seemingly disparate parts of class, or by applying tools to setting they have not seen before. 
- I suspect that many students who were unhappy with difficulty did not take advantage of office hours, Piazza Q&A, TAs, study groups, or math/econ workshops.
- Students did not fully appreciate that course is intented to be somewhat theoretical and abstract. I think my course is within the normal range of mathematical rigor and theory vs application.

Changes:

- Will make exams slightly shorter and easier.
- Will make problem sets slightly shorter and easier.
- Will improve connection between lecture material and assesments.
- Will consider more numerical examples and problems.
- Will return exams within 2 weeks.
- Will post weekly problem sets much earlier, ideally at beginning of semester.


